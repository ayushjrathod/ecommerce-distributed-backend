services:
  # Application Services
  users-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      API_SECRET: secret
      KAFKA_BROKERS: kafka:9092
      MONGO_URI: mongodb://username:password@mongo-users:27017/users-service?authSource=admin
      USERS_SERVICE_PORT: 8000
      METRICS_PORT: 9201
    ports:
      - 8001:8000
      - 9201:9201
    depends_on:
      - mongo-users
      - kafka
    networks:
      - backend

  orders-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:9092
      USERS_SERVICE_URL: http://users-service:8000
      PRODUCTS_SERVICE_URL: http://products-service:8000
      MONGO_URI: mongodb://username:password@mongo-orders:27017/orders-service?authSource=admin
      ORDERS_SERVICE_PORT: 8000
      METRICS_PORT: 9202
    ports:
      - 8002:8000
      - 9202:9202
    depends_on:
      - mongo-orders
      - kafka
    networks:
      - backend

  products-service:
    build:
      context: ./services/product-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:9092
      MONGO_URI: mongodb://username:password@mongo-products:27017/products-service?authSource=admin
      PRODUCTS_SERVICE_PORT: 8000
      METRICS_PORT: 9203
    ports:
      - 8003:8000
      - 9203:9203
    depends_on:
      - mongo-products
      - kafka
    networks:
      - backend

  notifications-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:9092
      MONGO_URI: mongodb://username:password@mongo-notifications:27017/notifications-service?authSource=admin
      SMTP_HOST: 'smtp.gmail.com'
      SMTP_PORT: '587'
      SMTP_SECURE: 'false'
      SMTP_USER: 'ayushjrathod75@gmail.com'
      SMTP_PASS: 'gxlx dfvl wpty avwh'
      SENDER_EMAIL: 'ayushjrathod75@gmail.com'
      USERS_SERVICE_URL: 'http://users-service:8000'
      NOTIFICATIONS_SERVICE_URL: 'http://notifications-service:8004'
      NOTIFICATIONS_SERVICE_PORT: 8004
      METRICS_PORT: 9205
    ports:
      - 8004:8000
      - 9205:9205
    depends_on:
      - mongo-notifications
      - kafka
    networks:
      - backend

  fastapi-recommendation-service:
    build:
      context: ./services/fastapi-recommendation-service
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:9092
      USERS_SERVICE_URL: http://users-service:8000
      PRODUCTS_SERVICE_URL: http://products-service:8000
      ORDERS_SERVICE_URL: http://orders-service:8000
      REDIS_URL: redis://cache-db:6379
      RECOMMENDATIONS_SERVICE_PORT: 8000
      METRICS_PORT: 9204
    ports:
      - 8005:8000
      - 9204:9204
    depends_on:
      - cache-db
      - orders-service
      - users-service
      - products-service
      - kafka
    networks:
      - backend

  graphql-gateway:
    build:
      context: ./graphql-gateway
      dockerfile: Dockerfile
    environment:
      NODE_ENV: development
      API_SECRET: secret
      USERS_SERVICE_URL: http://users-service:8000
      ORDERS_SERVICE_URL: http://orders-service:8000
      PRODUCTS_SERVICE_URL: http://products-service:8000
      REDIS_URL: redis://cache-db:6379
      KAFKA_BROKERS: kafka:9092
      PORT: '4000'
    ports:
      - '4000:4000'
    depends_on:
      - users-service
      - orders-service
      - products-service
      - cache-db
      - kafka
    networks:
      - backend

  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
    ports:
      - 8080:8080
    environment:
      NODE_ENV: development
      KAFKA_BROKERS: kafka:9092
      PORT: 8080
    depends_on:
      - kafka
    networks:
      - backend

  seeder:
    image: node:18
    working_dir: /app
    volumes:
      - ./:/app
    command: ['node', 'seed.js']
    depends_on:
      - graphql-gateway
    networks:
      - backend
    environment:
      - NODE_ENV=development

  # Databases
  mongo-users:
    image: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: username
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: users-service
    ports:
      - 27017:27017
    networks:
      - backend

  mongo-orders:
    image: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: username
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: orders-service
    ports:
      - 27018:27017
    networks:
      - backend

  mongo-products:
    image: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: username
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: products-service
    ports:
      - 27019:27017
    networks:
      - backend

  mongo-notifications:
    image: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: username
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: notifications-service
    ports:
      - 27020:27017
    networks:
      - backend

  cache-db:
    image: redis
    ports:
      - 6379:6379
    networks:
      - backend

  # Message Broker (KRaft mode - Kafka without Zookeeper)
  kafka:
    image: apache/kafka:latest
    ports:
      - 9092:9092
    environment:
      # Unique identifier for this Kafka node in the cluster (must be unique per node)
      KAFKA_NODE_ID: 1
      
      # Defines the roles this node will serve: 'broker' handles client requests,
      # 'controller' manages cluster metadata (topics, partitions, replicas)
      # Combined mode (broker,controller) is suitable for development/single-node setups
      KAFKA_PROCESS_ROLES: broker,controller
      
      # Network listeners for different types of connections:
      # - PLAINTEXT://0.0.0.0:9092: Client connections (producers/consumers)
      # - CONTROLLER://0.0.0.0:9093: Inter-controller communication for metadata consensus
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      
      # Address advertised to clients for connecting to this broker
      # Use 'kafka' hostname for Docker network communication
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      
      # Specifies which listener is used for controller-to-controller communication
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      
      # Maps listener names to security protocols (PLAINTEXT = no encryption)
      # In production, consider using SSL or SASL_SSL for security
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      
      # List of controller nodes participating in metadata quorum (Raft consensus)
      # Format: node_id@host:port (here: node 1 at kafka:9093)
      # For multi-node clusters, list all controllers: 1@kafka1:9093,2@kafka2:9093,3@kafka3:9093
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      
      # Number of replicas for the __consumer_offsets topic (stores consumer positions)
      # Set to 1 for development, use 3+ for production high availability
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      
      # Number of replicas for transaction state logs (ensures exactly-once semantics)
      # Set to 1 for development, use 3+ for production
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      
      # Minimum in-sync replicas for transaction logs before write is considered successful
      # Set to 1 for development, use 2+ for production (ensures durability)
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      
      # Initial delay before consumer group rebalancing starts (in milliseconds)
      # 0 = start rebalancing immediately (good for dev), use 3000-30000 for production
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      
      # Default number of partitions for auto-created topics
      # More partitions = better parallelism, use 3-6 for production
      KAFKA_NUM_PARTITIONS: 1
      
      # Unique cluster identifier (base64-encoded UUID)
      # Generate new ID with: `kafka-storage.sh random-uuid` or use any 22-char base64 string
      # This ID must remain constant for the cluster lifetime
      CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'
    networks:
      - backend

  # Monitoring
  prometheus:
    image: prom/prometheus
    ports:
      - '9090:9090'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'

  grafana:
    image: grafana/grafana
    ports:
      - '3000:3000'
    volumes:
      - grafana-storage:/var/lib/grafana

networks:
  backend:

volumes:
  grafana-storage:
